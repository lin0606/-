# Tcp协议介绍

推荐阅读：[阮一峰计算机网络协议](https://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html)

TCP协议是位于传输层之上，当我们在“网络层”建立了主机到主机之间联系后，我们的两台主机便可以互通消息，但是每台主机都会运行不同的程序（或是说有多个进程），例如实时聊天，浏览网页等。

这时计算机网络便需要一个参数来进行数据与进程之间的对应，在我们的操作系统中进程可以使用pid来表示，但是我们计算机之间的进程通信不一定建立在同一个操作系统之下。所以计算机网络在这里引入了端口号（port）这一概念。例如我们常见的80端口，443端口等。

**"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。**因此，Unix系统就把主机+端口，叫做"套接字"（socket）。有了它，就可以进行网络应用程序开发了。

对于网络层有两个重要的协议，分别是TCP和UDP协议。

## TCP和UDP的区别

| UDP(User Datagram Protocol)<br />用户数据报协议 | TCP(Transmission Control Protocol)<br />传输控制协议 |
| ----------------------------------------------- | ---------------------------------------------------- |
| 无连接                                          | 面向连接                                             |
| 支持一对一，一对多，多对一和多对多交互通信      | 每一条TCP连接只能有两个端点EP，只能是一对一通信      |
| 对应用层交付的报文直接打包                      | 面向字节流                                           |
| 尽最大努力交付，不可靠                          | 可靠传输，使用流量控制和拥塞控制                     |
| 首部开销小，8字节                               | 首部最小20字节，最大40字节                           |

## TCP协议

### 概述

TCP是位于以太网和协议和IP协议的上层协议，应用层协议的下层协议。

**以太网协议**规定了电子信号如何组成数据报，解决了子网内部点对点通信。

**IP协议**主要解决多个局域网之间的通信。IP协议定义了一套自己的地址规则，称为IP地址。它实现了路由功能，允许某个局域网的A主机，向另一个局域网的B主机发送消息。IP 协议只是一个地址协议，并不保证数据包的完整。如果路由器丢包（比如缓存满了，新进来的数据包就会丢失），就需要发现丢了哪一个包，以及如何重新发送这个包。这就要依靠 TCP 协议。

**TCP协议**的主要作用便是，保证数据通信的完整性和可靠性，防止丢包。

### TCP流量控制

一般情况下，我们希望通信双方数据传输更快，但是如果我们的发送方发送的数据过快，导致接收方来不及接收就有可能导致数据丢失。

为了防止这种情况的出现，TCP引入了流量控制。所谓的流量控制就是让发送方的发送速率不要太快，要让接收方来得及接收。在这里**TCP使用了滑动窗口机制来实现在TCP连接上对于发送方的流量控制**。

[计网微课堂流量控制](https://www.bilibili.com/video/BV1c4411d7jb?p=60)

### TCP拥塞控制

在某段时间，若对网络中某一资源的需求超过了该资源所提供的可用部分，网络性能就要变坏。这种情况就叫做拥塞。

我们计算机网络中，链路带宽、交换节点的缓存和处理机，都是网络的资源。

若出现拥塞而不进行控制，整个网络的吞吐量将随输入负荷的增大而下降。

Tcp提供了四种拥塞控制算法，分别是：慢开始，拥塞避免，快重传，快恢复。

![](C:\Users\ASUS\Desktop\note\images\network\tcp1.png)

[计网微课堂拥塞控制](https://www.bilibili.com/video/BV1c4411d7jb?p=61)

发送方在确定发送报文段的速率时，既要根据接收方的接收能力，又要从全局考虑不要使网络发生拥塞。因此，Tcp协议要求发送方维护一下两个窗口：

1. 接收窗口：接收方根据目前接收缓存大小所许诺的最新窗口值，反映接收方的容量。并由接收方根据其放在TCP报文的首部的窗口字段通知发送方
2. 拥塞窗口：发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络的当前容量。只要网络未出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现阻塞，拥塞窗口就减小一些，以减少注入网络的分组数。

>  发送窗口的上限值应取接收窗口和拥塞窗口中较小的一个。

### 连接管理

为了保证数据传输的可靠性，再进行数据通信之前，TCP需要建立一条专用通道。这个过程便是TCP的三次握手。

<img src="C:\Users\ASUS\Desktop\note\images\network\tcp2.jpg" style="zoom:67%;" />

起初，服务器和客户端都为CLOSED状态。在通信开始前，双方都得创建各自的传输控制块（TCB）。 服务器创建完TCB后遍进入LISTEN状态，此时准备接收客户端发来的连接请求。

**第一次握手**

客户端向服务端发送连接请求报文段。该报文段的头部中SYN=1，ACK=0，seq=x。请求发送后，客户端便进入SYN-SENT状态。

- PS1：SYN=1，ACK=0表示该报文段为连接请求报文。
- PS2：x为本次TCP通信的字节流的初始序号。 TCP规定：SYN=1的报文段不能有数据部分，但要消耗掉一个序号

**第二次握手**

服务端收到连接请求报文段后，如果同意连接，则会发送一个应答：SYN=1，ACK=1，seq=y，ack=x+1。 该应答发送完成后便进入SYN-RCVD状态。

- PS1：SYN=1，ACK=1表示该报文段为连接同意的应答报文。
- PS2：seq=y表示服务端作为发送者时，发送字节流的初始序号。
- PS3：ack=x+1表示服务端希望下一个数据报发送序号从x+1开始的字节。

**第三次握手**

当客户端收到连接同意的应答后，还要向服务端发送一个确认报文段，表示：服务端发来的连接同意应答已经成功收到。 该报文段的头部为：ACK=1，seq=x+1，ack=y+1。 客户端发完这个报文段后便进入ESTABLISHED状态，服务端收到这个应答后也进入ESTABLISHED状态，此时连接的建立完成！

**为何不能两次握手**

如客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，同意建立连接，不采用三次握手，只要服务端发出确认，就建立新的连接了，此时客户端忽略服务端发来的确认，也不发送数据，则服务端一致等待客户端发送数据，浪费资源。



